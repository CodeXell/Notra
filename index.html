<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Notra</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="Notra Icon-1024.png">
  
<style>
:root{
  --bg:#0a1020;
  --surface:#111a33;
  --surface-2:#0e1730;
  --accent:#4dc3ff;
  --text:#ffffff;
  --muted:rgba(255,255,255,.65);
  --border:rgba(255,255,255,.08);
  --highlight:#7f5fff;
  --sidebar-collapsed:70px;
  --sidebar-expanded:280px;
  --success:#4ade80;
  --warning:#fbbf24;
  --danger:#f87171;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(1200px 600px at 20% -10%, #15245a 0%, transparent 60%),
    radial-gradient(900px 500px at 90% 10%, #0f2a4f 0%, transparent 55%),
    var(--bg);
  color:var(--text);
  overflow:hidden;
  -webkit-tap-highlight-color: transparent;
}

.app-container{
  display:flex;
  height:100vh;
  flex-direction:column;
}

.main-layout{
  display:flex;
  flex:1;
  overflow:hidden;
}

.sidebar{
  width:var(--sidebar-collapsed);
  background:linear-gradient(180deg,#0e1833,#0b142b);
  border-right:1px solid var(--border);
  transition:width .3s cubic-bezier(0.4, 0.0, 0.2, 1);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  position:relative;
  z-index:100;
}

.sidebar:hover{
  width:var(--sidebar-expanded);
}

.sidebar-header{
  padding:20px;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
}

.sidebar-header h1{
  font-size:15px;
  font-weight:700;
  color:var(--accent);
  margin:0;
  letter-spacing:.03em;
}

.sidebar-content{
  padding:20px;
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
}

.sidebar-footer{
  padding:20px;
  border-top:1px solid var(--border);
  white-space:nowrap;
}

.sidebar-title{
  font-size:11px;
  font-weight:700;
  color:var(--muted);
  letter-spacing:.12em;
  text-transform:uppercase;
  margin-bottom:14px;
  white-space:nowrap;
}

.sidebar-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.sidebar-action{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:10px;
  background:linear-gradient(135deg,rgba(77,195,255,.08),rgba(127,95,255,.08));
  border:1px solid var(--border);
  cursor:pointer;
  transition:all .3s ease;
  white-space:nowrap;
  min-height:48px;
}

.sidebar-action:hover{
  background:linear-gradient(135deg,rgba(77,195,255,.15),rgba(127,95,255,.15));
  border-color:rgba(77,195,255,.3);
  transform:translateX(5px);
  box-shadow:0 8px 24px rgba(77,195,255,.2);
}

.sidebar-action-icon{
  font-size:20px;
  min-width:20px;
  text-align:center;
}

.sidebar-action-content{
  flex:1;
  opacity:0;
  transition:opacity .3s ease .1s;
}

.sidebar:hover .sidebar-action-content{
  opacity:1;
}

.sidebar-action-title{
  font-weight:600;
  font-size:14px;
  margin-bottom:2px;
}

.sidebar-action-desc{
  font-size:12px;
  color:var(--muted);
}

.content-area{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.workspace{
  flex:1;
  overflow-y:auto;
  padding:30px;
}

.content-header{
  padding:20px 30px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,rgba(14,24,51,.6),rgba(11,20,43,.4));
  backdrop-filter:blur(10px);
}

.content-header h2{
  margin:0;
  font-size:24px;
  font-weight:700;
  background:linear-gradient(135deg,var(--accent),var(--highlight));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

#backButton{
  display:none;
  margin:0 0 20px 0;
  padding:10px 20px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  color:#06101f;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}

#backButton:hover{
  transform:scale(1.08);
  box-shadow:0 0 18px rgba(77,195,255,.6);
}

.panel{
  background:linear-gradient(180deg,var(--surface),var(--surface-2));
  border-radius:16px;
  padding:24px;
  border:1px solid var(--border);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
}

.notes-toolbar{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.notes-toolbar input{
  flex:1;
  min-width:250px;
  padding:12px 16px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(13,22,51,.8);
  color:white;
  font-size:14px;
  transition:all .3s ease;
}

.notes-toolbar input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
  animation:focusPulse 1.5s ease-in-out infinite;
}

@keyframes focusPulse{
  0%, 100%{
    box-shadow:0 0 20px rgba(77,195,255,.3);
  }
  50%{
    box-shadow:0 0 30px rgba(77,195,255,.6);
  }
}

.notes-toolbar button{
  padding:12px 20px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  color:#06101f;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}

.notes-toolbar button:hover{
  transform:scale(1.08);
  box-shadow:0 0 18px rgba(77,195,255,.6);
}

.notes-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:16px;
  margin-bottom:20px;
}

.note{
  background:linear-gradient(180deg,#1a2760,#121c44);
  border-radius:12px;
  padding:16px;
  border:1px solid var(--border);
  position:relative;
  word-wrap:break-word;
  transition:all .3s ease;
}

.note:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 40px rgba(77,195,255,.2);
  border-color:rgba(77,195,255,.4);
}

.note-title{
  font-weight:600;
  margin-bottom:10px;
  padding-right:90px;
  font-size:15px;
}

.note-content{
  font-size:14px;
  color:var(--muted);
  line-height:1.6;
}

.note-content h1, .note-content h2, .note-content h3{
  color:var(--accent);
  margin-top:12px;
  margin-bottom:8px;
}

.note-content code{
  background:rgba(0,0,0,.3);
  padding:2px 6px;
  border-radius:4px;
  font-family:monospace;
}

.note-content pre{
  background:rgba(0,0,0,.3);
  padding:12px;
  border-radius:8px;
  overflow-x:auto;
}

.note-content pre code{
  background:transparent;
  padding:0;
}

.note-content blockquote{
  border-left:3px solid var(--accent);
  padding-left:12px;
  margin-left:0;
  color:var(--muted);
}

.note-content a{
  color:var(--accent);
  text-decoration:none;
}

.note-content a:hover{
  text-decoration:underline;
}

.note-controls{
  position:absolute;
  top:12px;
  right:12px;
  display:flex;
  gap:8px;
  font-size:13px;
  align-items:center;
}

.note-controls span{
  cursor:pointer;
  color:var(--accent);
  padding:4px 8px;
  border-radius:6px;
  transition:background .15s ease;
}

.note-controls span:hover{
  background:rgba(77,195,255,.15);
}

.note-md-badge{
  font-size:10px;
  padding:3px 8px;
  background:rgba(127,95,255,.35);
  border-radius:999px;
  color:white;
  font-weight:600;
  cursor:default;
}

.note-md-badge.active{
  background:var(--highlight);
}

.status-bar-container{
  background:linear-gradient(180deg,#0b142b,#0e1833);
  border-top:1px solid var(--border);
  padding:12px 30px;
  display:flex;
  align-items:center;
  gap:12px;
  z-index:50;
  flex-wrap:wrap;
}

.status-pill{
  padding:6px 14px;
  border-radius:999px;
  background:rgba(77,195,255,.12);
  border:1px solid rgba(77,195,255,.35);
  font-size:12px;
  transition:all .3s ease;
}

.status-pill:hover{
  background:rgba(77,195,255,.2);
  transform:scale(1.05);
}

#versionPage{
  display:none;
  padding:60px 30px;
  text-align:center;
}

#versionPage p{
  font-size:20px;
  margin-bottom:30px;
}

#versionPage .version-logo{
  width:200px;
  height:200px;
  margin:0 auto;
  background:linear-gradient(135deg,var(--accent),var(--highlight));
  border-radius:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:48px;
  font-weight:700;
  color:white;
  box-shadow:0 20px 60px rgba(77,195,255,.3);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  backdrop-filter:blur(4px);
  padding:20px;
}

.modal-content{
  background:linear-gradient(180deg,#111a33,#0e1730);
  border-radius:16px;
  border:1px solid var(--border);
  padding:28px;
  max-width:600px;
  width:100%;
  max-height:80vh;
  overflow-y:auto;
  box-shadow:0 30px 80px rgba(0,0,0,.8);
}

.modal-content h3{
  margin:0 0 20px 0;
  color:var(--accent);
  font-size:22px;
}

.modal-content input[type="text"],
.modal-content input[type="email"],
.modal-content input[type="password"]{
  width:100%;
  padding:12px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0d1633;
  color:white;
  margin-bottom:14px;
  font-family:inherit;
  font-size:14px;
  transition:all .3s ease;
}

.modal-content input[type="text"]:focus,
.modal-content input[type="email"]:focus,
.modal-content input[type="password"]:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
  animation:focusPulse 1.5s ease-in-out infinite;
}

.modal-content input[type="text"].error{
  animation:errorFlash 0.5s ease-in-out 3;
  border-color:#ff4444;
}

@keyframes errorFlash{
  0%, 100%{
    border-color:#ff4444;
    box-shadow:0 0 20px rgba(255,68,68,.4);
  }
  50%{
    border-color:#ff0000;
    box-shadow:0 0 30px rgba(255,0,0,.7);
  }
}

@keyframes shake{
  0%, 100%{
    transform:translateX(0);
  }
  10%, 30%, 50%, 70%, 90%{
    transform:translateX(-10px);
  }
  20%, 40%, 60%, 80%{
    transform:translateX(10px);
  }
}

.input-error{
  animation:shake 0.6s ease-in-out, errorFlash 0.5s ease-in-out 3;
  border-color:#ff4444 !important;
}

.error-message{
  color:#ff4444;
  font-size:13px;
  margin:-10px 0 14px 0;
  display:none;
  font-weight:600;
}

.error-message.show{
  display:block;
}

.modal-content textarea{
  width:100%;
  padding:12px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0d1633;
  color:white;
  margin-bottom:14px;
  font-family:inherit;
  min-height:200px;
  resize:vertical;
  font-size:14px;
  line-height:1.6;
  transition:all .3s ease;
}

.modal-content textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
  animation:focusPulse 1.5s ease-in-out infinite;
}

.modal-content label{
  display:flex;
  align-items:center;
  gap:10px;
  margin:14px 0;
  color:var(--muted);
  font-size:14px;
  cursor:pointer;
}

.modal-content input[type="checkbox"]{
  cursor:pointer;
}

.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin-top:24px;
  flex-wrap:wrap;
}

.modal-actions button{
  padding:10px 24px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
  flex:1;
  min-width:100px;
}

.modal-actions .cancelBtn{
  background:rgba(255,255,255,.1);
  color:white;
}

.modal-actions .saveBtn{
  background:var(--accent);
  color:#06101f;
}

.modal-actions button:hover{
  transform:scale(1.06);
}

.confirm-dialog{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
  backdrop-filter:blur(4px);
  padding:20px;
}

.confirm-dialog-content{
  background:linear-gradient(180deg,#111a33,#0e1730);
  border-radius:16px;
  border:1px solid var(--border);
  padding:28px;
  max-width:400px;
  width:100%;
  box-shadow:0 30px 80px rgba(0,0,0,.8);
}

.confirm-dialog-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:16px;
}

.confirm-dialog-icon{
  font-size:32px;
}

.confirm-dialog-title{
  font-size:20px;
  font-weight:700;
  color:var(--accent);
}

.confirm-dialog-message{
  color:var(--muted);
  line-height:1.6;
  margin-bottom:24px;
  font-size:15px;
}

.confirm-dialog-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  flex-wrap:wrap;
}

.confirm-dialog-actions button{
  padding:10px 24px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
  flex:1;
  min-width:100px;
}

.confirm-dialog-actions .confirm-cancel{
  background:rgba(255,255,255,.1);
  color:white;
}

.confirm-dialog-actions .confirm-yes{
  background:#ff4444;
  color:white;
}

.confirm-dialog-actions button:hover{
  transform:scale(1.06);
}

.tabs{
  display:flex;
  gap:8px;
  margin-bottom:14px;
  border-bottom:1px solid var(--border);
}

.tab{
  padding:10px 24px;
  background:transparent;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  border-bottom:2px solid transparent;
  transition:all .15s ease;
}

.tab:hover{
  color:var(--text);
}

.tab.active{
  color:var(--accent);
  border-bottom-color:var(--accent);
}

.tab-content{
  display:none;
}

.tab-content.active{
  display:block;
}

.preview-content{
  padding:14px;
  background:#0d1633;
  border-radius:10px;
  border:1px solid var(--border);
  min-height:200px;
  color:var(--text);
  line-height:1.6;
}

.preview-content h1, .preview-content h2, .preview-content h3{
  color:var(--accent);
  margin-top:14px;
  margin-bottom:10px;
}

.preview-content code{
  background:rgba(0,0,0,.3);
  padding:2px 6px;
  border-radius:4px;
  font-family:monospace;
}

.preview-content pre{
  background:rgba(0,0,0,.3);
  padding:12px;
  border-radius:8px;
  overflow-x:auto;
}

.preview-content pre code{
  background:transparent;
  padding:0;
}

.preview-content blockquote{
  border-left:3px solid var(--accent);
  padding-left:12px;
  margin-left:0;
  color:var(--muted);
}

.preview-content a{
  color:var(--accent);
  text-decoration:none;
}

.preview-content a:hover{
  text-decoration:underline;
}

.preview-content ul, .preview-content ol{
  padding-left:20px;
}

.highlight{
  background:rgba(127,95,255,.6);
  padding:2px 4px;
  border-radius:4px;
  animation:highlightPulse 2s ease-in-out infinite;
}

@keyframes highlightPulse{
  0%, 100%{
    background:rgba(127,95,255,.6);
    box-shadow:0 0 10px rgba(127,95,255,.3);
  }
  50%{
    background:rgba(127,95,255,.8);
    box-shadow:0 0 20px rgba(127,95,255,.5);
  }
}

.empty-state{
  text-align:center;
  padding:60px 20px;
  color:var(--muted);
}

.empty-state div:first-child{
  font-size:56px;
  margin-bottom:16px;
}

.empty-state div:last-child{
  font-size:16px;
}

/* Auth Section Styles */
#authSection{
  display:none;
}

.auth-panel{
  max-width:400px;
  margin:40px auto;
}

.auth-toggle{
  text-align:center;
  margin-top:16px;
  color:var(--muted);
  font-size:14px;
}

.auth-toggle button{
  background:none;
  border:none;
  color:var(--accent);
  cursor:pointer;
  text-decoration:underline;
  font-size:14px;
}

.auth-message{
  padding:12px;
  border-radius:8px;
  margin-bottom:14px;
  font-size:14px;
  text-align:center;
}

.auth-message.error{
  background:rgba(255,68,68,.2);
  border:1px solid rgba(255,68,68,.4);
  color:#ff4444;
}

.auth-message.success{
  background:rgba(77,195,255,.2);
  border:1px solid rgba(77,195,255,.4);
  color:var(--accent);
}

.user-info{
  display:flex;
  align-items:center;
  gap:12px;
  padding:8px 0;
  flex-wrap:wrap;
}

/* Profile Picture */
.profile-pic{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid var(--accent);
  box-shadow:0 0 12px rgba(77,195,255,.3);
}

.username-display{
  font-size:14px;
  font-weight:600;
  color:var(--text);
}

/* ===== AUTH INPUTS ===== */
#authSection input[type="email"],
#authSection input[type="password"],
#authSection input[type="text"]{
  width:100%;
  padding:12px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0d1633;
  color:white;
  margin-bottom:14px;
  font-family:inherit;
  font-size:14px;
  transition:all .3s ease;
}

#authSection input[type="email"]:focus,
#authSection input[type="password"]:focus,
#authSection input[type="text"]:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
  animation:focusPulse 1.5s ease-in-out infinite;
}

/* ===== AUTH BUTTONS ===== */
.auth-btn{
  flex:1;
  padding:12px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
  transition:transform .15s ease, box-shadow .15s ease;
  min-width:120px;
}

.auth-btn.primary{
  background:var(--accent);
  color:#06101f;
}

.auth-btn.secondary{
  background:rgba(77,195,255,.2);
  color:var(--accent);
}

.auth-btn:hover{
  transform:scale(1.08);
  box-shadow:0 0 18px rgba(77,195,255,.6);
}

/* ===== SETTINGS PAGE ===== */
#settingsPage{
  display:none;
}

.settings-grid{
  display:grid;
  gap:20px;
  max-width:800px;
  margin:0 auto;
}

.settings-section{
  background:linear-gradient(180deg,var(--surface),var(--surface-2));
  border-radius:16px;
  padding:24px;
  border:1px solid var(--border);
  box-shadow:0 12px 40px rgba(0,0,0,.3);
}

.settings-section-title{
  font-size:18px;
  font-weight:700;
  color:var(--accent);
  margin:0 0 20px 0;
  display:flex;
  align-items:center;
  gap:10px;
}

.settings-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 0;
  border-bottom:1px solid var(--border);
}

.settings-item:last-child{
  border-bottom:none;
}

.settings-item-info{
  flex:1;
}

.settings-item-label{
  font-weight:600;
  font-size:15px;
  color:var(--text);
  margin-bottom:4px;
}

.settings-item-desc{
  font-size:13px;
  color:var(--muted);
}

.settings-item-control{
  margin-left:20px;
}

/* Custom Toggle Switch */
.toggle-switch{
  position:relative;
  width:56px;
  height:30px;
  background:rgba(255,255,255,.1);
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  transition:all .3s ease;
}

.toggle-switch.active{
  background:linear-gradient(135deg,var(--accent),var(--highlight));
  border-color:var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.4);
}

.toggle-switch-slider{
  position:absolute;
  top:3px;
  left:3px;
  width:22px;
  height:22px;
  background:white;
  border-radius:50%;
  transition:all .3s cubic-bezier(0.4, 0.0, 0.2, 1);
  box-shadow:0 2px 8px rgba(0,0,0,.3);
}

.toggle-switch.active .toggle-switch-slider{
  left:29px;
}

/* Profile Picture Upload */
.profile-pic-upload{
  display:flex;
  align-items:center;
  gap:20px;
  padding:20px 0;
}

.profile-pic-large{
  width:100px;
  height:100px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
}

.profile-pic-placeholder{
  width:100px;
  height:100px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--highlight));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  font-weight:700;
  color:white;
  border:3px solid var(--accent);
  box-shadow:0 0 20px rgba(77,195,255,.3);
}

.profile-pic-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.profile-pic-actions button{
  padding:10px 20px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
  font-size:13px;
}

.profile-pic-actions button:first-child{
  background:var(--accent);
  color:#06101f;
}

.profile-pic-actions button:last-child{
  background:rgba(255,68,68,.2);
  color:#ff6666;
}

.profile-pic-actions button:hover{
  transform:scale(1.06);
}

.profile-pic-actions input[type="file"]{
  display:none;
}

/* Settings Buttons */
.settings-button{
  padding:12px 24px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  color:#06101f;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
  font-size:14px;
}

.settings-button:hover{
  transform:scale(1.06);
  box-shadow:0 0 18px rgba(77,195,255,.6);
}

.settings-button.danger{
  background:rgba(255,68,68,.3);
  color:#ff6666;
}

/* Logout Animation */
.logout-overlay{
  position:fixed;
  inset:0;
  background:var(--bg);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
  background:
    radial-gradient(1200px 600px at 50% 50%, #15245a 0%, transparent 60%),
    radial-gradient(900px 500px at 50% 50%, #0f2a4f 0%, transparent 55%),
    var(--bg);
}

.logout-animation{
  font-size:80px;
  font-weight:700;
  letter-spacing:8px;
  display:flex;
  gap:4px;
}

.logout-letter{
  opacity:0;
  transform:translateY(50px);
  animation:letterAppear 0.5s ease forwards;
  background:linear-gradient(135deg,var(--accent),var(--highlight));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.logout-letter:nth-child(1){animation-delay:0s;}
.logout-letter:nth-child(2){animation-delay:0.1s;}
.logout-letter:nth-child(3){animation-delay:0.2s;}
.logout-letter:nth-child(4){animation-delay:0.3s;}
.logout-letter:nth-child(5){animation-delay:0.4s;}

@keyframes letterAppear{
  to{
    opacity:1;
    transform:translateY(0);
  }
}

.logout-letter.fade-out{
  animation:letterDisappear 0.3s ease forwards;
}

@keyframes letterDisappear{
  to{
    opacity:0;
    transform:scale(0.5);
  }
}

.logout-o{
  width:120px;
  height:120px;
  border-radius:50%;
  border:8px solid transparent;
  background:linear-gradient(var(--bg),var(--bg)) padding-box,
              linear-gradient(135deg,var(--accent),var(--highlight)) border-box;
  display:none;
  animation:oPulse 1.5s ease-in-out infinite;
}

@keyframes oPulse{
  0%, 100%{
    box-shadow:0 0 30px rgba(77,195,255,.6);
    transform:scale(1);
  }
  50%{
    box-shadow:0 0 60px rgba(127,95,255,.8);
    transform:scale(1.1);
  }
}

.logout-o.spin{
  animation:oSpin 1s linear infinite, oPulse 1.5s ease-in-out infinite;
}

@keyframes oSpin{
  to{
    transform:rotate(360deg);
  }
}

/* ===================== MOBILE RESPONSIVE STYLES ===================== */

@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: -100%;
    top: 0;
    bottom: 0;
    width: 280px;
    z-index: 1000;
    transition: left .3s ease;
    box-shadow: 2px 0 10px rgba(0,0,0,.5);
  }
  
  .sidebar.mobile-open {
    left: 0;
  }
  
  .sidebar.mobile-open .sidebar-action-content {
    opacity: 1;
  }
  
  .mobile-menu-btn {
    display: block;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    font-size: 24px;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 4px 12px rgba(77,195,255,.4);
    transition: transform .2s ease;
  }
  
  .mobile-menu-btn:active {
    transform: scale(0.95);
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    z-index: 999;
    backdrop-filter: blur(2px);
  }
  
  .sidebar-overlay.active {
    display: block;
  }
  
  .content-area {
    width: 100%;
  }
  
  .content-header {
    padding: 15px 20px;
  }
  
  .content-header h2 {
    font-size: 20px;
  }
  
  .workspace {
    padding: 20px 15px;
  }
  
  .panel {
    padding: 16px;
    border-radius: 12px;
  }
  
  .notes-toolbar {
    flex-direction: column;
    gap: 10px;
  }
  
  .notes-toolbar input {
    min-width: 100%;
    width: 100%;
  }
  
  .notes-toolbar button {
    width: 100%;
    padding: 14px 20px;
  }
  
  .notes-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .status-bar-container {
    padding: 10px 15px;
    justify-content: center;
  }
  
  .status-pill {
    font-size: 11px;
    padding: 5px 10px;
  }
  
  .modal {
    padding: 10px;
  }
  
  .modal-content {
    padding: 20px;
    max-height: 90vh;
  }
  
  .modal-content h3 {
    font-size: 18px;
  }
  
  .modal-content textarea {
    min-height: 150px;
  }
  
  .confirm-dialog {
    padding: 10px;
  }
  
  .confirm-dialog-content {
    padding: 20px;
  }
  
  .user-info {
    font-size: 12px;
  }
  
  .username-display {
    font-size: 12px !important;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .auth-panel {
    margin: 20px;
  }
  
  #versionPage {
    padding: 40px 20px;
  }
  
  #versionPage p {
    font-size: 16px;
  }
  
  #versionPage .version-logo {
    width: 150px;
    height: 150px;
    font-size: 36px;
  }
  
  .tabs {
    gap: 4px;
  }
  
  .tab {
    padding: 8px 16px;
    font-size: 13px;
  }
  
  .empty-state div:first-child {
    font-size: 40px;
  }
  
  .empty-state div:last-child {
    font-size: 14px;
  }
  
  .settings-grid {
    padding: 0;
  }
  
  .settings-section {
    padding: 20px;
  }
  
  .settings-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .settings-item-control {
    margin-left: 0;
    width: 100%;
  }
  
  .profile-pic-upload {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  
  .profile-pic-actions {
    width: 100%;
  }
  
  .profile-pic-actions button {
    width: 100%;
  }
  
  .logout-animation{
    font-size:50px;
  }
  
  .logout-o{
    width:80px;
    height:80px;
  }
}

@media (max-width: 480px) {
  .content-header h2 {
    font-size: 18px;
  }
  
  .workspace {
    padding: 15px 10px;
  }
  
  .panel {
    padding: 12px;
  }
  
  .modal-content {
    padding: 16px;
  }
  
  .notes-toolbar button {
    font-size: 13px;
  }
  
  .note-title {
    font-size: 14px;
    padding-right: 80px;
  }
  
  .note-content {
    font-size: 13px;
  }
  
  .modal-actions {
    flex-direction: column-reverse;
  }
  
  .modal-actions button {
    width: 100%;
  }
}

@media (max-height: 600px) and (orientation: landscape) {
  .modal-content textarea {
    min-height: 100px;
  }
  
  .workspace {
    padding: 15px;
  }
}

</style>
</head>

<body>

<button class="mobile-menu-btn" id="mobileMenuBtn" style="display:none;">‚ò∞</button>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Logout Animation Overlay -->
<div class="logout-overlay" id="logoutOverlay">
  <div class="logout-animation" id="logoutAnimation">
    <span class="logout-letter">N</span>
    <span class="logout-letter">o</span>
    <span class="logout-letter">t</span>
    <span class="logout-letter">r</span>
    <span class="logout-letter">a</span>
  </div>
  <div class="logout-o" id="logoutO"></div>
</div>

<div class="app-container">
  <!-- Auth Section -->
  <div id="authSection">
    <div class="workspace">
      <div class="auth-panel panel">
        <h2 style="text-align:center; margin-bottom:24px;">Welcome to Notra</h2>
        <div id="authMessage" class="auth-message" style="display:none;"></div>
        
        <div class="error-message" id="emailError">Email incorrect</div>
        <input type="email" id="authEmail" placeholder="Email" style="display:block;">
        
        <div class="error-message" id="passwordError">Password incorrect</div>
        <input type="password" id="authPassword" placeholder="Password" style="display:block;">
        
        <input type="text" id="authUsername" placeholder="Username" style="display:none;">
        
        <div style="display:flex; gap:12px; margin-top:20px; flex-wrap:wrap;">
          <button id="signInBtn" class="auth-btn primary">Sign In</button>
          <button id="signUpBtn" class="auth-btn secondary">Sign Up</button>
        </div>
        
        <div class="auth-toggle">
          <p>Your notes will sync automatically to the cloud and be available on any device.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="main-layout" id="mainApp" style="display:none;">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>NOTRA</h1>
      </div>
      
      <div class="sidebar-content">
        <div class="sidebar-title">Quick Actions</div>
        <div class="sidebar-actions">
          <div class="sidebar-action" data-url="mailto:abdullahbinnuman511@gmail.com">
            <div class="sidebar-action-icon">‚úâÔ∏è</div>
            <div class="sidebar-action-content">
              <div class="sidebar-action-title">Contact Notra</div>
              <div class="sidebar-action-desc">Support or enquiries</div>
            </div>
          </div>
          
          <div class="sidebar-action" data-url="https://docs.google.com/document/d/1sKoZ2Dyv1tQ7Wfl8OCMlpBWfPtatzVgIIttIHWMMZxU/edit">
            <div class="sidebar-action-icon">üìÑ</div>
            <div class="sidebar-action-content">
              <div class="sidebar-action-title">Terms of Service</div>
              <div class="sidebar-action-desc">Policies & conditions</div>
            </div>
          </div>
          
          <div class="sidebar-action" id="softwareVersionBtn">
            <div class="sidebar-action-icon">‚ÑπÔ∏è</div>
            <div class="sidebar-action-content">
              <div class="sidebar-action-title">Software Version</div>
              <div class="sidebar-action-desc">View current version</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <div class="sidebar-actions">
          <div class="sidebar-action" id="settingsBtn">
            <div class="sidebar-action-icon">‚öôÔ∏è</div>
            <div class="sidebar-action-content">
              <div class="sidebar-action-title">Settings</div>
              <div class="sidebar-action-desc">Manage your account</div>
            </div>
          </div>
          
          <div class="sidebar-action" id="logOutBtn">
            <div class="sidebar-action-icon">üö™</div>
            <div class="sidebar-action-content">
              <div class="sidebar-action-title">Log Out</div>
              <div class="sidebar-action-desc">Sign out of account</div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <div class="content-area">
      <div class="content-header">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 id="pageTitle">üìù My Notes</h2>
          <div class="user-info">
            <img id="userProfilePic" class="profile-pic" style="display:none;">
            <span id="usernameDisplay" class="username-display"></span>
          </div>
        </div>
      </div>
      
      <div class="workspace" id="appContent">
        <button id="backButton">‚Üê Back</button>
        
        <!-- Notes Page -->
        <div class="panel" id="notesPanel">
          <div class="notes-toolbar">
            <input id="searchNotes" placeholder="üîç Search notes...">
            <button id="addNote">+ Add Note</button>
            <button id="downloadNote">‚¨á Export</button>
          </div>
          <div class="notes-grid" id="notesGrid"></div>
        </div>

        <!-- Version Page -->
        <div id="versionPage">
          <p>Your software is running Notra - Version 4.2.1 (Cloud Sync)</p>
          <div class="version-logo">NOTRA</div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage">
          <div class="settings-grid">
            <!-- Profile Section -->
            <div class="settings-section">
              <div class="settings-section-title">
                <span>üë§</span>
                <span>Profile</span>
              </div>
              
              <div class="profile-pic-upload">
                <img id="settingsProfilePic" class="profile-pic-large" style="display:none;">
                <div id="settingsProfilePlaceholder" class="profile-pic-placeholder">U</div>
                <div class="profile-pic-actions">
                  <button onclick="document.getElementById('profilePicInput').click()">Upload Picture</button>
                  <button id="removeProfilePicBtn">Remove Picture</button>
                  <input type="file" id="profilePicInput" accept="image/*">
                </div>
              </div>
            </div>

            <!-- Account Settings -->
            <div class="settings-section">
              <div class="settings-section-title">
                <span>üîê</span>
                <span>Account</span>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Username</div>
                  <div class="settings-item-desc">Change your display name</div>
                </div>
                <div class="settings-item-control">
                  <button class="settings-button" id="editUsernameBtn">Edit</button>
                </div>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Password</div>
                  <div class="settings-item-desc">Update your password</div>
                </div>
                <div class="settings-item-control">
                  <button class="settings-button" id="editPasswordBtn">Change</button>
                </div>
              </div>
            </div>

            <!-- Editor Preferences -->
            <div class="settings-section">
              <div class="settings-section-title">
                <span>‚úèÔ∏è</span>
                <span>Editor</span>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Markdown Everywhere</div>
                  <div class="settings-item-desc">Enable markdown for all new notes by default</div>
                </div>
                <div class="settings-item-control">
                  <div class="toggle-switch" id="markdownEverywhereToggle">
                    <div class="toggle-switch-slider"></div>
                  </div>
                </div>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Auto-Save</div>
                  <div class="settings-item-desc">Automatically save notes while typing</div>
                </div>
                <div class="settings-item-control">
                  <div class="toggle-switch active" id="autoSaveToggle">
                    <div class="toggle-switch-slider"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Appearance -->
            <div class="settings-section">
              <div class="settings-section-title">
                <span>üé®</span>
                <span>Appearance</span>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Compact Mode</div>
                  <div class="settings-item-desc">Show more notes in less space</div>
                </div>
                <div class="settings-item-control">
                  <div class="toggle-switch" id="compactModeToggle">
                    <div class="toggle-switch-slider"></div>
                  </div>
                </div>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Show Line Numbers</div>
                  <div class="settings-item-desc">Display line numbers in editor</div>
                </div>
                <div class="settings-item-control">
                  <div class="toggle-switch" id="lineNumbersToggle">
                    <div class="toggle-switch-slider"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Data & Privacy -->
            <div class="settings-section">
              <div class="settings-section-title">
                <span>üîí</span>
                <span>Data & Privacy</span>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Export All Data</div>
                  <div class="settings-item-desc">Download all your notes and settings</div>
                </div>
                <div class="settings-item-control">
                  <button class="settings-button" id="exportAllBtn">Export</button>
                </div>
              </div>
              
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Clear Cache</div>
                  <div class="settings-item-desc">Clear local cached data</div>
                </div>
                <div class="settings-item-control">
                  <button class="settings-button danger" id="clearCacheBtn">Clear</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="status-bar-container" id="statusBar" style="display:none;">
    <div class="status-pill" id="statusApp">üü¢ App Ready</div>
    <div class="status-pill" id="statusNet">üåê Online</div>
    <div class="status-pill" id="statusSync">‚òÅÔ∏è Synced</div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmDialog" class="confirm-dialog">
  <div class="confirm-dialog-content">
    <div class="confirm-dialog-header">
      <div class="confirm-dialog-icon">‚ö†Ô∏è</div>
      <div class="confirm-dialog-title">Notra</div>
    </div>
    <div class="confirm-dialog-message" id="confirmMessage">
      Are you sure you want to delete this note?
    </div>
    <div class="confirm-dialog-actions">
      <button class="confirm-cancel" id="confirmCancelBtn">Cancel</button>
      <button class="confirm-yes" id="confirmYesBtn">Yes</button>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div id="noteModal" class="modal">
  <div class="modal-content">
    <h3 id="noteModalTitle">Add Note</h3>
    <input type="text" id="noteTitle" placeholder="Note title...">
    
    <label>
      <input type="checkbox" id="markdownCheckbox">
      Enable Markdown for this note
    </label>
    
    <div class="tabs" id="editorTabs" style="display:none;">
      <button class="tab active" data-tab="write">Write</button>
      <button class="tab" data-tab="preview">Preview</button>
    </div>
    
    <div class="tab-content active" id="writeTab">
      <textarea id="noteContent" placeholder="Note content..."></textarea>
    </div>
    
    <div class="tab-content" id="previewTab">
      <div class="preview-content" id="previewContent">
        <p style="color:var(--muted);">Nothing to preview yet...</p>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="cancelBtn" id="cancelNoteBtn">Cancel</button>
      <button class="saveBtn" id="saveNoteBtn">Save</button>
    </div>
  </div>
</div>

<!-- Edit Username Modal -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Edit Username</h3>
    <input type="text" id="newUsername" placeholder="Enter new username">
    <div class="modal-actions">
      <button class="cancelBtn" id="cancelUsernameBtn">Cancel</button>
      <button class="saveBtn" id="saveUsernameBtn">Save</button>
    </div>
  </div>
</div>

<!-- Edit Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3>Change Password</h3>
    <input type="password" id="currentPassword" placeholder="Current password">
    <input type="password" id="newPassword" placeholder="New password">
    <input type="password" id="confirmPassword" placeholder="Confirm new password">
    <div class="modal-actions">
      <button class="cancelBtn" id="cancelPasswordBtn">Cancel</button>
      <button class="saveBtn" id="savePasswordBtn">Save</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, orderBy, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyC2mQSgu5pxNk74f7TWafAFzehBgGC2nI4",
  authDomain: "notra-98c76.firebaseapp.com",
  projectId: "notra-98c76",
  storageBucket: "notra-98c76.firebasestorage.app",
  messagingSenderId: "166720115809",
  appId: "1:166720115809:web:0049b8dfd7a1301ab5c620",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let notes = [];
let currentEditIndex = -1;
let searchQuery = '';
let confirmCallback = null;
let isSignUpMode = false;
let userSettings = {
  markdownEverywhere: false,
  autoSave: true,
  compactMode: false,
  lineNumbers: false
};

// DOM Elements
const authSection = document.getElementById('authSection');
const mainApp = document.getElementById('mainApp');
const statusBar = document.getElementById('statusBar');
const backButton = document.getElementById('backButton');
const notesPanel = document.getElementById('notesPanel');
const versionPage = document.getElementById('versionPage');
const settingsPage = document.getElementById('settingsPage');
const pageTitle = document.getElementById('pageTitle');
const grid = document.getElementById('notesGrid');
const searchInput = document.getElementById('searchNotes');
const noteContentTextarea = document.getElementById('noteContent');
const previewContent = document.getElementById('previewContent');
const editorTabs = document.getElementById('editorTabs');
const markdownCheckbox = document.getElementById('markdownCheckbox');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const authUsername = document.getElementById('authUsername');
const signInBtn = document.getElementById('signInBtn');
const signUpBtn = document.getElementById('signUpBtn');
const authMessage = document.getElementById('authMessage');
const emailError = document.getElementById('emailError');
const passwordError = document.getElementById('passwordError');
const usernameDisplay = document.getElementById('usernameDisplay');
const userProfilePic = document.getElementById('userProfilePic');
const settingsBtn = document.getElementById('settingsBtn');
const logOutBtn = document.getElementById('logOutBtn');
const statusSync = document.getElementById('statusSync');

// Settings Elements
const settingsProfilePic = document.getElementById('settingsProfilePic');
const settingsProfilePlaceholder = document.getElementById('settingsProfilePlaceholder');
const profilePicInput = document.getElementById('profilePicInput');
const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
const editUsernameBtn = document.getElementById('editUsernameBtn');
const editPasswordBtn = document.getElementById('editPasswordBtn');
const markdownEverywhereToggle = document.getElementById('markdownEverywhereToggle');
const autoSaveToggle = document.getElementById('autoSaveToggle');
const compactModeToggle = document.getElementById('compactModeToggle');
const lineNumbersToggle = document.getElementById('lineNumbersToggle');
const exportAllBtn = document.getElementById('exportAllBtn');
const clearCacheBtn = document.getElementById('clearCacheBtn');

// Logout Animation
const logoutOverlay = document.getElementById('logoutOverlay');
const logoutAnimation = document.getElementById('logoutAnimation');
const logoutO = document.getElementById('logoutO');

// Mobile
function isMobile() {
  return window.innerWidth <= 768;
}

function updateMobileUI() {
  if (isMobile()) {
    mobileMenuBtn.style.display = 'block';
  } else {
    mobileMenuBtn.style.display = 'none';
    sidebar.classList.remove('mobile-open');
    sidebarOverlay.classList.remove('active');
  }
}

mobileMenuBtn.onclick = function() {
  sidebar.classList.toggle('mobile-open');
  sidebarOverlay.classList.toggle('active');
};

sidebarOverlay.onclick = function() {
  sidebar.classList.remove('mobile-open');
  sidebarOverlay.classList.remove('active');
};

document.querySelectorAll('.sidebar-action').forEach(function(action) {
  action.addEventListener('click', function() {
    if (isMobile()) {
      sidebar.classList.remove('mobile-open');
      sidebarOverlay.classList.remove('active');
    }
  });
});

window.addEventListener('resize', updateMobileUI);

// Auth Error Handling
function showInputError(input, errorElement) {
  input.classList.add('input-error');
  errorElement.classList.add('show');
  
  setTimeout(() => {
    input.classList.remove('input-error');
    errorElement.classList.remove('show');
  }, 3000);
}

function showAuthMessage(message, isError = false) {
  authMessage.textContent = message;
  authMessage.className = 'auth-message ' + (isError ? 'error' : 'success');
  authMessage.style.display = 'block';
  setTimeout(() => {
    authMessage.style.display = 'none';
  }, 5000);
}

// Sign Up Flow
signUpBtn.onclick = async function() {
  if (!isSignUpMode) {
    authUsername.style.display = 'block';
    signUpBtn.textContent = 'Create Account';
    signInBtn.textContent = 'Back to Sign In';
    isSignUpMode = true;
    return;
  }
  
  const email = authEmail.value.trim();
  const password = authPassword.value.trim();
  const username = authUsername.value.trim();
  
  if (!email || !password || !username) {
    showAuthMessage('Please fill all fields', true);
    return;
  }
  
  if (password.length < 6) {
    showAuthMessage('Password must be at least 6 characters', true);
    return;
  }
  
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    
    await setDoc(doc(db, 'users', userCredential.user.uid, 'profile', 'data'), {
      username: username,
      email: email,
      profilePicture: null,
      settings: userSettings,
      createdAt: Date.now()
    });
    
    showAuthMessage('Account created successfully!');
  } catch (error) {
    console.error('Sign up error:', error);
    if (error.code === 'auth/email-already-in-use') {
      showAuthMessage('This email is already registered', true);
    } else if (error.code === 'auth/invalid-email') {
      showInputError(authEmail, emailError);
    } else {
      showAuthMessage('Sign up failed. Please try again.', true);
    }
  }
};

// Sign In
signInBtn.onclick = async function() {
  if (isSignUpMode) {
    authUsername.style.display = 'none';
    authUsername.value = '';
    signUpBtn.textContent = 'Sign Up';
    signInBtn.textContent = 'Sign In';
    isSignUpMode = false;
    return;
  }
  
  const email = authEmail.value.trim();
  const password = authPassword.value.trim();
  
  if (!email || !password) {
    showAuthMessage('Please enter email and password', true);
    return;
  }
  
  try {
    await signInWithEmailAndPassword(auth, email, password);
    showAuthMessage('Signed in successfully!');
  } catch (error) {
    console.error('Sign in error:', error);
    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
      showInputError(authPassword, passwordError);
    } else if (error.code === 'auth/user-not-found') {
      showInputError(authEmail, emailError);
    } else if (error.code === 'auth/invalid-email') {
      showInputError(authEmail, emailError);
    } else {
      showAuthMessage('Sign in failed. Please check your credentials.', true);
    }
  }
};

// Logout with Animation
logOutBtn.onclick = function() {
  showConfirmDialog('Are you sure you want to log out?', async function() {
    await performLogout();
  });
};

async function performLogout() {
  logoutOverlay.style.display = 'flex';
  
  // Step 1: Show letters appearing
  const letters = document.querySelectorAll('.logout-letter');
  letters.forEach(letter => {
    letter.classList.remove('fade-out');
    letter.style.opacity = '0';
  });
  
  logoutAnimation.style.display = 'flex';
  logoutO.style.display = 'none';
  
  await new Promise(resolve => setTimeout(resolve, 2500));
  
  // Step 2: Fade out letters
  letters.forEach(letter => {
    letter.classList.add('fade-out');
  });
  
  await new Promise(resolve => setTimeout(resolve, 800));
  
  // Step 3: Show pulsing O
  logoutAnimation.style.display = 'none';
  logoutO.style.display = 'block';
  logoutO.classList.remove('spin');
  
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  // Step 4: Spin the O
  logoutO.classList.add('spin');
  
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // Actually sign out
  try {
    await signOut(auth);
  } catch (error) {
    console.error('Sign out error:', error);
  }
  
  logoutOverlay.style.display = 'none';
}

// Load User Profile
async function loadUserProfile(user) {
  try {
    const profileDoc = await getDoc(doc(db, 'users', user.uid, 'profile', 'data'));
    if (profileDoc.exists()) {
      const data = profileDoc.data();
      usernameDisplay.textContent = data.username || 'User';
      
      if (data.profilePicture) {
        userProfilePic.src = data.profilePicture;
        userProfilePic.style.display = 'block';
        settingsProfilePic.src = data.profilePicture;
        settingsProfilePic.style.display = 'block';
        settingsProfilePlaceholder.style.display = 'none';
      } else {
        userProfilePic.style.display = 'none';
        settingsProfilePic.style.display = 'none';
        settingsProfilePlaceholder.style.display = 'flex';
        settingsProfilePlaceholder.textContent = (data.username || 'U').charAt(0).toUpperCase();
      }
      
      if (data.settings) {
        userSettings = { ...userSettings, ...data.settings };
        updateSettingsUI();
      }
    }
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

// Save User Profile
async function saveUserProfile(updates) {
  if (!auth.currentUser) return;
  
  try {
    const profileRef = doc(db, 'users', auth.currentUser.uid, 'profile', 'data');
    await updateDoc(profileRef, updates);
    console.log('Profile updated in Firestore');
  } catch (error) {
    console.error('Error saving profile:', error);
  }
}

// Update Settings UI
function updateSettingsUI() {
  markdownEverywhereToggle.classList.toggle('active', userSettings.markdownEverywhere);
  autoSaveToggle.classList.toggle('active', userSettings.autoSave);
  compactModeToggle.classList.toggle('active', userSettings.compactMode);
  lineNumbersToggle.classList.toggle('active', userSettings.lineNumbers);
}

// Toggle Switches
function setupToggle(toggle, settingKey) {
  toggle.onclick = function() {
    userSettings[settingKey] = !userSettings[settingKey];
    toggle.classList.toggle('active', userSettings[settingKey]);
    saveUserProfile({ settings: userSettings });
  };
}

setupToggle(markdownEverywhereToggle, 'markdownEverywhere');
setupToggle(autoSaveToggle, 'autoSave');
setupToggle(compactModeToggle, 'compactMode');
setupToggle(lineNumbersToggle, 'lineNumbers');

// Profile Picture Upload
profilePicInput.onchange = async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.size > 2 * 1024 * 1024) {
    showConfirmDialog('Image must be less than 2MB', function() {});
    return;
  }
  
  const reader = new FileReader();
  reader.onload = async function(event) {
    const imageData = event.target.result;
    
    userProfilePic.src = imageData;
    userProfilePic.style.display = 'block';
    settingsProfilePic.src = imageData;
    settingsProfilePic.style.display = 'block';
    settingsProfilePlaceholder.style.display = 'none';
    
    await saveUserProfile({ profilePicture: imageData });
  };
  reader.readAsDataURL(file);
};

removeProfilePicBtn.onclick = async function() {
  userProfilePic.style.display = 'none';
  settingsProfilePic.style.display = 'none';
  settingsProfilePlaceholder.style.display = 'flex';
  
  await saveUserProfile({ profilePicture: null });
};

// Edit Username
editUsernameBtn.onclick = function() {
  document.getElementById('newUsername').value = usernameDisplay.textContent;
  document.getElementById('usernameModal').style.display = 'flex';
};

document.getElementById('cancelUsernameBtn').onclick = function() {
  document.getElementById('usernameModal').style.display = 'none';
};

document.getElementById('saveUsernameBtn').onclick = async function() {
  const newUsername = document.getElementById('newUsername').value.trim();
  
  if (!newUsername) {
    document.getElementById('newUsername').classList.add('error');
    setTimeout(() => {
      document.getElementById('newUsername').classList.remove('error');
    }, 1500);
    return;
  }
  
  usernameDisplay.textContent = newUsername;
  settingsProfilePlaceholder.textContent = newUsername.charAt(0).toUpperCase();
  await saveUserProfile({ username: newUsername });
  
  document.getElementById('usernameModal').style.display = 'none';
};

// Edit Password
editPasswordBtn.onclick = function() {
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('passwordModal').style.display = 'flex';
};

document.getElementById('cancelPasswordBtn').onclick = function() {
  document.getElementById('passwordModal').style.display = 'none';
};

document.getElementById('savePasswordBtn').onclick = async function() {
  const currentPass = document.getElementById('currentPassword').value;
  const newPass = document.getElementById('newPassword').value;
  const confirmPass = document.getElementById('confirmPassword').value;
  
  if (!currentPass || !newPass || !confirmPass) {
    showConfirmDialog('Please fill all password fields', function() {});
    return;
  }
  
  if (newPass.length < 6) {
    showConfirmDialog('New password must be at least 6 characters', function() {});
    return;
  }
  
  if (newPass !== confirmPass) {
    showConfirmDialog('Passwords do not match', function() {});
    return;
  }
  
  try {
    const user = auth.currentUser;
    const credential = EmailAuthProvider.credential(user.email, currentPass);
    await reauthenticateWithCredential(user, credential);
    await updatePassword(user, newPass);
    
    document.getElementById('passwordModal').style.display = 'none';
    showConfirmDialog('Password updated successfully!', function() {});
  } catch (error) {
    console.error('Password update error:', error);
    showConfirmDialog('Error: ' + error.message, function() {});
  }
};

// Settings Button
settingsBtn.onclick = function() {
  notesPanel.style.display = 'none';
  versionPage.style.display = 'none';
  settingsPage.style.display = 'block';
  pageTitle.textContent = '‚öôÔ∏è Settings';
  backButton.style.display = 'inline-block';
  
  if (isMobile()) {
    sidebar.classList.remove('mobile-open');
    sidebarOverlay.classList.remove('active');
  }
};

// Export All Data
exportAllBtn.onclick = function() {
  const exportData = {
    notes: notes,
    settings: userSettings,
    username: usernameDisplay.textContent,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'notra-backup-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
};

// Clear Cache
clearCacheBtn.onclick = function() {
  showConfirmDialog('Clear all cached data? This will not delete your cloud notes.', function() {
    localStorage.clear();
    showConfirmDialog('Cache cleared successfully!', function() {});
  });
};

// Auth State Listener
onAuthStateChanged(auth, async (user) => {
  if (user) {
    authSection.style.display = 'none';
    mainApp.style.display = 'flex';
    statusBar.style.display = 'flex';
    updateMobileUI();
    
    await loadUserProfile(user);
    await loadNotes();
  } else {
    authSection.style.display = 'block';
    mainApp.style.display = 'none';
    statusBar.style.display = 'none';
    mobileMenuBtn.style.display = 'none';
    notes = [];
    renderNotes();
    
    authEmail.value = '';
    authPassword.value = '';
    authUsername.value = '';
    authUsername.style.display = 'none';
    signUpBtn.textContent = 'Sign Up';
    signInBtn.textContent = 'Sign In';
    isSignUpMode = false;
  }
});

// Save Note
async function saveNote() {
  const titleInput = document.getElementById('noteTitle');
  const title = titleInput.value.trim();
  const content = noteContentTextarea.value.trim();
  const isMarkdown = markdownCheckbox.checked;
  
  if (!title) {
    titleInput.classList.add('error');
    setTimeout(function() {
      titleInput.classList.remove('error');
      titleInput.focus();
    }, 1500);
    return;
  }
  
  const noteData = {
    title: title,
    content: content,
    isMarkdown: isMarkdown,
    updatedAt: Date.now()
  };
  
  if (currentEditIndex === -1) {
    noteData.id = Date.now().toString();
    notes.push(noteData);
  } else {
    noteData.id = notes[currentEditIndex].id;
    notes[currentEditIndex] = noteData;
  }
  
  localStorage.setItem(`note_${noteData.id}`, JSON.stringify(noteData));
  
  if (auth.currentUser) {
    try {
      statusSync.textContent = '‚è≥ Syncing...';
      await setDoc(
        doc(db, 'users', auth.currentUser.uid, 'notes', noteData.id),
        noteData
      );
      statusSync.textContent = '‚òÅÔ∏è Synced';
    } catch (error) {
      console.error('Cloud sync failed:', error);
      statusSync.textContent = '‚ö†Ô∏è Sync Failed';
    }
  }
  
  closeNoteModal();
  renderNotes();
}

// Load Notes
async function loadNotes() {
  const localNotes = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('note_')) {
      try {
        const note = JSON.parse(localStorage.getItem(key));
        localNotes.push(note);
      } catch (e) {
        console.error('Error parsing note:', e);
      }
    }
  }
  
  notes = localNotes;
  renderNotes();
  
  if (auth.currentUser) {
    try {
      statusSync.textContent = '‚è≥ Syncing...';
      const notesRef = collection(db, 'users', auth.currentUser.uid, 'notes');
      const q = query(notesRef, orderBy('updatedAt', 'desc'));
      const snapshot = await getDocs(q);
      
      const cloudNotes = [];
      snapshot.forEach(doc => {
        cloudNotes.push(doc.data());
      });
      
      const merged = mergeNotes(localNotes, cloudNotes);
      
      merged.forEach(note => {
        localStorage.setItem(`note_${note.id}`, JSON.stringify(note));
      });
      
      notes = merged;
      renderNotes();
      statusSync.textContent = '‚òÅÔ∏è Synced';
    } catch (error) {
      console.error('Cloud load failed:', error);
      statusSync.textContent = '‚ö†Ô∏è Sync Failed';
    }
  }
}

function mergeNotes(localNotes, cloudNotes) {
  const notesMap = new Map();
  
  localNotes.forEach(note => {
    notesMap.set(note.id, note);
  });
  
  cloudNotes.forEach(note => {
    const existing = notesMap.get(note.id);
    if (!existing || note.updatedAt > existing.updatedAt) {
      notesMap.set(note.id, note);
    }
  });
  
  return Array.from(notesMap.values());
}

async function handleDelete(index) {
  showConfirmDialog('Are you sure you want to delete this note?', async function() {
    const noteId = notes[index].id;
    
    notes.splice(index, 1);
    localStorage.removeItem(`note_${noteId}`);
    
    if (auth.currentUser) {
      try {
        statusSync.textContent = '‚è≥ Syncing...';
        await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'notes', noteId));
        statusSync.textContent = '‚òÅÔ∏è Synced';
      } catch (error) {
        console.error('Cloud delete failed:', error);
        statusSync.textContent = '‚ö†Ô∏è Sync Failed';
      }
    }
    
    renderNotes();
  });
}

function showConfirmDialog(message, callback) {
  document.getElementById('confirmMessage').textContent = message;
  document.getElementById('confirmDialog').style.display = 'flex';
  confirmCallback = callback;
}

function closeConfirmDialog() {
  document.getElementById('confirmDialog').style.display = 'none';
  confirmCallback = null;
}

function confirmDialogYes() {
  if (confirmCallback) {
    confirmCallback();
  }
  closeConfirmDialog();
}

document.getElementById('confirmCancelBtn').onclick = closeConfirmDialog;
document.getElementById('confirmYesBtn').onclick = confirmDialogYes;

document.getElementById('softwareVersionBtn').onclick = function() {
  notesPanel.style.display = 'none';
  settingsPage.style.display = 'none';
  versionPage.style.display = 'block';
  pageTitle.textContent = '‚ÑπÔ∏è Version';
  backButton.style.display = 'inline-block';
  
  if (isMobile()) {
    sidebar.classList.remove('mobile-open');
    sidebarOverlay.classList.remove('active');
  }
};

backButton.onclick = function() {
  notesPanel.style.display = '';
  settingsPage.style.display = 'none';
  versionPage.style.display = 'none';
  pageTitle.textContent = 'üìù My Notes';
  backButton.style.display = 'none';
};

document.querySelectorAll('.sidebar-action[data-url]').forEach(function(action) {
  action.onclick = function() {
    const url = action.getAttribute('data-url');
    if (url) window.open(url, '_blank');
  };
});

const statusNet = document.getElementById('statusNet');
statusNet.textContent = navigator.onLine ? 'üåê Online' : 'üî¥ Offline';
window.addEventListener('online', function() {
  statusNet.textContent = 'üåê Online';
});
window.addEventListener('offline', function() {
  statusNet.textContent = 'üî¥ Offline';
});

markdownCheckbox.addEventListener('change', function() {
  if (markdownCheckbox.checked) {
    editorTabs.style.display = 'flex';
  } else {
    editorTabs.style.display = 'none';
    document.querySelectorAll('.tab').forEach(function(t) {
      t.classList.remove('active');
    });
    document.querySelector('.tab[data-tab="write"]').classList.add('active');
    document.querySelectorAll('.tab-content').forEach(function(content) {
      content.classList.remove('active');
    });
    document.getElementById('writeTab').classList.add('active');
  }
});

document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    const tabName = tab.getAttribute('data-tab');
    
    document.querySelectorAll('.tab').forEach(function(t) {
      t.classList.remove('active');
    });
    tab.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(function(content) {
      content.classList.remove('active');
    });
    
    if (tabName === 'write') {
      document.getElementById('writeTab').classList.add('active');
    } else if (tabName === 'preview') {
      document.getElementById('previewTab').classList.add('active');
      updatePreview();
    }
  });
});

function updatePreview() {
  const content = noteContentTextarea.value.trim();
  if (!content) {
    previewContent.innerHTML = '<p style="color:var(--muted);">Nothing to preview yet...</p>';
    return;
  }
  
  if (markdownCheckbox.checked && typeof marked !== 'undefined') {
    previewContent.innerHTML = marked.parse(content);
  } else {
    previewContent.textContent = content;
  }
}

noteContentTextarea.addEventListener('input', function() {
  if (markdownCheckbox.checked && document.querySelector('.tab[data-tab="preview"]').classList.contains('active')) {
    updatePreview();
  }
});

function renderNotes() {
  grid.innerHTML = '';
  
  let filteredNotes = notes;
  
  if (searchQuery) {
    filteredNotes = notes.filter(function(n) {
      const searchText = (n.title + ' ' + n.content).toLowerCase();
      return searchText.includes(searchQuery.toLowerCase());
    });
  }
  
  if (filteredNotes.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div>üìù</div><div>' + (searchQuery ? 'No notes found' : 'No notes yet. Click "+ Add Note" to create one!') + '</div></div>';
    return;
  }
  
  filteredNotes.forEach(function(n) {
    const actualIndex = notes.indexOf(n);
    const div = document.createElement('div');
    div.className = 'note';
    
    let titleHTML = escapeHtml(n.title);
    let contentHTML = n.content;
    
    if (n.isMarkdown && typeof marked !== 'undefined') {
      contentHTML = marked.parse(n.content);
    } else {
      contentHTML = escapeHtml(n.content);
    }
    
    if (searchQuery) {
      const regex = new RegExp('(' + escapeRegex(searchQuery) + ')', 'gi');
      titleHTML = titleHTML.replace(regex, '<span class="highlight">$1</span>');
      
      if (!n.isMarkdown) {
        contentHTML = contentHTML.replace(regex, '<span class="highlight">$1</span>');
      }
    }
    
    const mdBadge = n.isMarkdown ? '<span class="note-md-badge active">MD</span>' : '';
    
    div.innerHTML = '<div class="note-controls">' + mdBadge + '<span onclick="handleEdit(' + actualIndex + ')" title="Edit">‚úèÔ∏è</span><span onclick="handleDelete(' + actualIndex + ')" title="Delete">üóëÔ∏è</span></div><div class="note-title">' + titleHTML + '</div><div class="note-content">' + contentHTML + '</div>';
    
    grid.appendChild(div);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

searchInput.oninput = function(e) {
  searchQuery = e.target.value;
  renderNotes();
};

document.getElementById('addNote').onclick = function() {
  currentEditIndex = -1;
  document.getElementById('noteModalTitle').textContent = 'Add Note';
  document.getElementById('noteTitle').value = '';
  noteContentTextarea.value = '';
  markdownCheckbox.checked = userSettings.markdownEverywhere;
  
  if (userSettings.markdownEverywhere) {
    editorTabs.style.display = 'flex';
  } else {
    editorTabs.style.display = 'none';
  }
  
  document.querySelectorAll('.tab').forEach(function(t) {
    t.classList.remove('active');
  });
  document.querySelector('.tab[data-tab="write"]').classList.add('active');
  document.querySelectorAll('.tab-content').forEach(function(content) {
    content.classList.remove('active');
  });
  document.getElementById('writeTab').classList.add('active');
  
  document.getElementById('noteModal').style.display = 'flex';
  
  setTimeout(function() {
    document.getElementById('noteTitle').focus();
  }, 100);
};

function closeNoteModal() {
  document.getElementById('noteModal').style.display = 'none';
  document.getElementById('noteTitle').value = '';
  noteContentTextarea.value = '';
  markdownCheckbox.checked = false;
  currentEditIndex = -1;
  document.getElementById('noteTitle').classList.remove('error');
}

function handleEdit(index) {
  currentEditIndex = index;
  document.getElementById('noteModalTitle').textContent = 'Edit Note';
  document.getElementById('noteTitle').value = notes[index].title;
  noteContentTextarea.value = notes[index].content;
  markdownCheckbox.checked = notes[index].isMarkdown || false;
  
  if (markdownCheckbox.checked) {
    editorTabs.style.display = 'flex';
  } else {
    editorTabs.style.display = 'none';
  }
  
  document.querySelectorAll('.tab').forEach(function(t) {
    t.classList.remove('active');
  });
  document.querySelector('.tab[data-tab="write"]').classList.add('active');
  document.querySelectorAll('.tab-content').forEach(function(content) {
    content.classList.remove('active');
  });
  document.getElementById('writeTab').classList.add('active');
  
  document.getElementById('noteModal').style.display = 'flex';
  
  setTimeout(function() {
    document.getElementById('noteTitle').focus();
  }, 100);
}

window.handleEdit = handleEdit;
window.handleDelete = handleDelete;

document.getElementById('cancelNoteBtn').onclick = closeNoteModal;
document.getElementById('saveNoteBtn').onclick = saveNote;

document.getElementById('downloadNote').onclick = function() {
  if (notes.length === 0) {
    showConfirmDialog('No notes to export', function() {});
    return;
  }
  
  let content = 'NOTRA - NOTES EXPORT\n';
  content += '================================\n\n';
  
  notes.forEach(function(n, i) {
    content += (i + 1) + '. ' + n.title;
    if (n.isMarkdown) content += ' [Markdown]';
    content += '\n';
    content += '-'.repeat(n.title.length + 3) + '\n';
    
    if (n.isMarkdown && typeof marked !== 'undefined') {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = marked.parse(n.content);
      content += tempDiv.textContent + '\n\n';
    } else {
      content += n.content + '\n\n';
    }
  });
  
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'notra-notes-' + new Date().toISOString().split('T')[0] + '.txt';
  a.click();
  URL.revokeObjectURL(url);
};

updateMobileUI();

console.log('‚ú® Notra app initialized with Firebase!');
console.log('üíæ Storage: localStorage + Firebase Cloud Sync');
console.log('üì± Mobile-friendly UI enabled');
console.log('üë§ User profiles and settings enabled');
console.log('üé¨ Logout animation enabled');
</script>

</body>
</html>
